version: "3"

services:
  api:
    build: ./ApiAlunos
    container_name: alunoapi
    networks:
      - aluno_network
      - proxy
    labels: 
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.alunoapi.entrypoint=http"
      - "traefik.http.routers.alunoapi.rule=Host(`desafioaevo.dodev.dev`) && (PathPrefix(`/api`)"
      - "traefik.http.midlewares.alunoapi-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.alunoapi-secure.entrypoints=https"
      - "traefik.http.routers.alunoapi-secure.rule=Host(`desafioaevo.dodev.dev`)"
      - "traefik.http.routers.alunoapi-secure.tls=true"
      - "traefik.http.routers.alunoapi-secure.tls.certresolver=http"
      - "traefik.http.routers.alunoapi-secure.service=alunoapi"
      - "traefik.http.services.alunoapi.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"
    depends_on:
      - db

  db:
    build: ./Database
    container_name: alunodb
    user: root
    networks:
      - aluno_network
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_PID=Developer
      - SA_PASSWORD=C0ns7tasDbp23
    volumes:
      - aluno_data:/var/opt/mssql/

  front:
    build: ./FrontAlunos
    container_name: alunoapi
    networks: 
      - aluno_network
      - proxy
    labels: 
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.alunoapi.entrypoint=http"
      - "traefik.http.routers.alunoapi.rule=Host(`desafioaevo.dodev.dev`)"
      - "traefik.http.midlewares.alunoapi-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.alunoapi-secure.entrypoints=https"
      - "traefik.http.routers.alunoapi-secure.rule=Host(`desafioaevo.dodev.dev`)"
      - "traefik.http.routers.alunoapi-secure.tls=true"
      - "traefik.http.routers.alunoapi-secure.tls.certresolver=http"
      - "traefik.http.routers.alunoapi-secure.service=alunoapi"
      - "traefik.http.services.alunoapi.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"
    
    

volumes:
  aluno_data:

networks:
  aluno_network:
  proxy:
    external: 
      name: proxy
